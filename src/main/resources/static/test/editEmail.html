<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
            integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"
            integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4"
            crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js"
            integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1"
            crossorigin="anonymous"></script>
    <title>Phishing Training Platform</title>
</head>

<body>
<style>
    body {
        background: linear-gradient(to right, rgba(255, 0, 0, 0), rgba(204, 204, 255));
    }

    .navbar {
        margin-bottom: 0 !important;
    }
</style>

<!-- navbar       -->
<nav class="navbar navbar-default">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="index.html">Home</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li><a href="uploadEmail.html">Upload Email Template</a></li>
                <li><a href="editEmail.html">Edit Email Template</a></li>
                <li><a href="logs.html">Logs</a></li>
            </ul>
        </div><!-- /.navbar-collapse -->
    </div><!-- /.container-fluid -->
</nav>

<!-- Navbar       -->

<h2 id="editLabel">Edit Email Templates</h2>
<!---display statistics---->
<table id="emailList" cellspacing="0" cellpadding="4" border="1" bordercolor="#224466" width="50%">
    <tr>
        <th>Name</th>
        <th>Created At</th>
        <th>Last Modified</th>
        <th>Edit</th>
        <th>Delete</th>
        <th>Send</th>
    </tr>
</table>

<dialog class="selectionDialog">
    From:
    <select class="spoofTargetSelect">
    </select>
    To:
    <select class="phishingTargetSelect">
    </select>
    <button onclick="addSpoopTarget()">Add Targets</button>
    <button onclick="send(this)">Send</button>
</dialog>

<script src="apiHelper.js"></script>
<script>


    const addUrl = "http://localhost:8080/api/emailTemplate/all";
    const deleteUrl = "http://localhost:8080/api/emailTemplate/del";
    const emails = document.getElementById("emailList");

    function showTemplates(templateJsons) {
        for (let templateJson of templateJsons) {
            const row = toRow(templateJson);
            emails.appendChild(row);
            console.log(templateJson);
        }
    }

    getRequest(addUrl, null, showTemplates);


    function toRow(templateJson) {
        const rowHtml = `
        <tr data-id="${templateJson.id}">
        <td>${templateJson.name}</td>
        <td>${templateJson.createdAt}</td>
        <td>${templateJson.lastModified}</td>
        <td><button onclick="editTemplate(${templateJson.id})">Edit</button></td>
        <td><button onclick="deleteTemplate(${templateJson.id},this)">Delete</button></td>
        <td><button onclick="startSend(this)">Send</button></td>
        </tr>
        `;

        return toNode(rowHtml);
    }

    function toNode(html) {
        const template = document.createElement('template');
        html = html.trim();
        template.innerHTML = html;
        return template.content;
    }

    function deleteTemplate(id, element) {
        const row = element.parentElement.parentElement;
        postRequest(deleteUrl, {id}, null,
            (response) => emails.removeChild(row)
        );
    }

    function editTemplate(id) {
        window.location.href = "http://localhost:8080/template-generator?id=" + id;
    }

    function startSend(element) {
        const templateId = element.parentElement.parentElement.getAttribute("data-id");
        openSelectionDialog(templateId)
    }

    function addSpoopTarget(){
        window.location.href="addTargets.html";
    }
    function send(element) {
        const sendUrl = new URL("http://localhost:8080/api/send");
        const dialog = element.parentElement;
        const phishingTargetId = document.querySelector(".phishingTargetSelect").value;
        const spoofTargetId = document.querySelector(".spoofTargetSelect").value;
        const templateId = dialog.getAttribute("pr-templateId");

        const sendParam = {templateId, spoofTargetId, phishingTargetId};

        sendUrl.search = new URLSearchParams(sendParam);
        closeSelectionDialog();
        fetch(sendUrl, {method:"POST"}).then(response => {
            console.log(response)
        })
    }

    function openSelectionDialog(templateId) {
        const dialog = document.querySelector(".selectionDialog");
        dialog.setAttribute("pr-templateId", templateId);
        dialog.setAttribute("open", "true");

    }

    function closeSelectionDialog() {
        const dialog = document.querySelector(".selectionDialog").removeAttribute("open");
    }

    function loadPhishingTargets() {
        const select = document.querySelector(".phishingTargetSelect");
        fetch("http://localhost:8080/api/phishingTarget/all").then(response => response.json()).then(json => {
                for (let j of json) {
                    const option = document.createElement("option");
                    option.value = j.id;
                    option.text = j.emailAddress;
                    select.appendChild(option);
                }
            }
        );
    }

    function loadSpoofTargets() {
        const select = document.querySelector(".spoofTargetSelect");
        fetch("http://localhost:8080/api/spoofTarget/all").then(response => response.json()).then(json => {
                for (let j of json) {
                    const option = document.createElement("option");
                    option.value = j.id;
                    option.text = j.emailAddress;
                    select.appendChild(option);
                }
            }
        );
    }

    loadPhishingTargets();
    loadSpoofTargets();

</script>

</body>
</html>