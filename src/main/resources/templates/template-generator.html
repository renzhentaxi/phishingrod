<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Template Generator</title>
    <script src="templateEditor.bundle.js" defer></script>
    <link rel="stylesheet" href="./index.css"/>
    <link rel="stylesheet" href="./parameter.css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js"
            integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1"
            crossorigin="anonymous"></script>
    <title>Phishing Training Platform</title>
</head>
<body>

<style>
    body {
        background: rgb(198,199,190);
    }

    .navbar {
        margin-bottom: 0 !important;
    }
</style>
<!-- navbar       -->
<nav class="navbar navbar-default">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../static/test/index.html">Home</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li><a href="../test/uploadEmail.html">Upload Email Template</a></li>
                <li><a href="../test/editEmail.html">Edit Email Template</a></li>
                <li><a href="../test/logs.html">Logs</a></li>
            </ul>
        </div><!-- /.navbar-collapse -->
    </div><!-- /.container-fluid -->
</nav>

<!-- Navbar       -->

<div class="container">
    <div class="header">
        <h1>Template Generator</h1>
    </div>

    <div class="body">
        <div class="pr-source" data-templateUrl="nope" data-id=1
             th:attr="data-templateUrl='/testHtml?id=' + ${id}, data-id=${id}" style="border: 1px solid black;">
        </div>
        <div class="pr-config" style="border: 1px solid black;">
            configuration
            <div class="Parameter-list"></div>
            <button id="save" onclick="onSubmit();">submit</button>
        </div>

    </div>
</div>

<script>

    const phishingTargetAlias = ["phishingTarget", "p", "ps", "pst", "pt", "phishing", "receiver", "to"];
    const spoofTargetAlias = ["spoofTarget", "s", "sp", "spt", "st", "spoof", "sender", "from"];


    function upload(modData) {
        fetch("http://localhost:8080/api/emailTemplate/mod?id=" + modData.id,
            {
                method: "POST",
                body: JSON.stringify(modData),
                headers:
                    {
                        'content-type': "application/json"
                    }
            }).then(response => console.log(response));
    }

    function onSubmit() {
        const sourceDocument = document.querySelector(".pr-source").firstElementChild.contentDocument;
        const sourceHtml = sourceDocument.body;
        const id = document.querySelector(".pr-source").getAttribute("data-id");

        const parameterList = document.querySelector(".Parameter-list");
        const parameters = processParameterList(sourceDocument, parameterList);
        upload(
            {
                id, sourceHtml:sourceHtml.innerHTML, parameters
            }
        )
    }

    function processParameterList(sourceDocument, parameterList) {
        const parameters = [];

        for (parameter of parameterList.children) {
            let raw = parameter.getAttribute("pr-param-name");


            const param = normalizeParameter(raw);
            fixParameterNodes(sourceDocument, param, raw);
            parameters.push(param);
        }
        return parameters;
    }

    function normalizeParameter(rawName) {
        let sourceType, name;
        if (!rawName.includes(".")) {
            sourceType = "phishingTarget";
            name = rawName;
        }
        else {
            [sourceType, name] = rawName.split(".");
        }

        if (phishingTargetAlias.includes(sourceType)) sourceType = "phishingTarget";
        else if (spoofTargetAlias.includes(sourceType)) sourceType = "spoofTarget";
        else console.error("invalid source " + sourceType);

        return {source: sourceType, name: name};
    }

    function fixParameterNodes(doc, param, originalName) {
        const query = `.pr-param-node[pr-param-name='${originalName}']`;
        const nodeList = doc.querySelectorAll(query);

        for (let i = 0; i < nodeList.length; i++) {
            const node = nodeList[i];
            node.setAttribute("pr-param-name", param.source + "." + param.name);
        }

    }

</script>
</body>
</html>